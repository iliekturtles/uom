language: rust
cache:
  directories:
  - /home/travis/.cargo
sudo: false
addons:
  apt:
    packages:
    - libssl-dev

rust:
- 1.24.1    # Oldest supported
- stable
- beta
- nightly
os:
- linux
- osx
- windows

matrix:
  allow_failures:
  - rust: nightly
  include:
  - name: "Rust: 1.22.0"   # Oldest compiled
    rust: 1.22.0
    script: |
      cargo build --verbose --features "use_serde"
  - name: "Rust: stable + tests"
    rust: stable
    script: |
      set -e
      cargo test --verbose --features "use_serde"
      cargo test -p feature_check --verbose --features "use_serde"
      cargo test -p edition_check --verbose --features "use_serde"
      cargo test --verbose --no-default-features --features "autoconvert f32 f64 si use_serde"
      cargo test --verbose --no-run --no-default-features --features "autoconvert usize u8 u16 u32 u64 isize i8 i16 i32 i64 bigint biguint rational rational32 rational64 bigrational f32 f64 std use_serde"
  - name: Rustfmt
    rust: 1.31.1
    install:
    - rustup component add rustfmt
    script:
    - cargo fmt -- --check
  - name: Deny warnings
    rust: 1.31.1
    script:
    - RUSTFLAGS="-D warnings" cargo check --tests
  - name: Clippy
    rust: 1.31.1
    install:
    - rustup component add clippy
    script:
    - cargo clippy -- -D clippy
  - name: Tarpaulin
    rust: 1.30.0
    sudo: required
    script:
    - docker run --security-opt seccomp=unconfined -v "$PWD:/volume" xd009642/tarpaulin sh -c "cargo build && cargo tarpaulin --ciserver travis-ci --coveralls $TRAVIS_JOB_ID"
  exclude:
  - os: linux     # Done by explicit job.
    rust: stable

install:
- rustc -Vv
- cargo -V

script: |
  set -e
  cargo test --verbose --features "use_serde"
  cargo test --manifest-path tests/feature_check/Cargo.toml --verbose

before_cache:
- rm -rf /home/travis/.cargo/registry

notifications:
  email:
    on_success: never
